var kchat=new Object();var chat=new Object();kchat.typing=0;kchat.scroll=0;kchat.msgoffset=0;kchat.msg=30;kchat.offset="none";kchat.notify=false;kchat.rqt_graph=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];var req={};req.premsg=false;Element.prototype.remove=function(){this.parentElement.removeChild(this)};NodeList.prototype.remove=HTMLCollection.prototype.remove=function(){for(var a=this.length-1;a>=0;a--){if(this[a]&&this[a].parentElement){this[a].parentElement.removeChild(this[a])}}};function isset(a){if(typeof a!=="undefined"){return true}else{return false}}function prepend(a,c){var b=$("#"+a);b.prepend(b.find("#tr"+c))}function drop_row(a,b){document.getElementById(a).deleteRow(b)}String.prototype.ucfirst=function(){return this.charAt(0).toUpperCase()+this.substr(1)};function __set(b,a){$("#"+b).html(a)}function kchat_message(a){if(!document.getElementById("messages")){return false}data="";info="";play=false;for(i=0;i<a.length;i++){data='<div class="msg-row"><div class="avatar"></div><div class="message'+a[i].align+'"><span class="user-label"><a href="#" style="color: #6D84B4;">'+a[i].username.ucfirst()+'</a> <span class="msg-time">'+a[i].sent_on+"</span></span><br/>"+a[i].message+"</div></div>";info+=a[i].id+" ";kchat.msgoffset=a[i].id;if(a[i].dir=="u2b"){$("#messages").append(data);$("#msgscrl").scrollTop($("#messages")[0].scrollHeight);play=true}else{if(a[i].dir=="b2u"){$("#messages").prepend(data)}}data=""}if(kchat.notify){if(play){playsound()}if(a.length!==0){notify(a.length+" new messages")}}$("emojionearea-editor").focus()}function playsound(){var a=new Audio();a.src=kurl+"/kchat/assets/audio/audio2.mp3";a.play()}function kchat_online(a){if(!document.getElementById("online")){return false}data="";for(i=0;i<a.length;i++){if(document.getElementById("online_"+a[i].id)){return false}data+='<div class="media" id="online_'+a[i].id+'" ><!--div class="pull-left"><img style="height:64px" src="128.jpg" class="media-photo"/></div--><div class="online-body"><span class="pull-right bullet">&#8226;</span><p class="title" style="font-size: 12px;" ><b><a href="#" style="text-decoration: none;color:#000" >'+a[i].username.ucfirst()+"</a></b></p></div></div>"}$("#online").prepend(data)}function kchat_offline(a){for(i=0;i<a.length;i++){if(document.getElementById("online_"+a[i])){document.getElementById("online_"+a[i]).remove()}}}function __kchat_chat(a){if(!document.getElementById("kchatchats")){return false}data="";for(i=0;i<a.length;i++){if(document.getElementById("chats"+a[i].id)){document.getElementById("chats"+a[i].id).remove()}data='<div class="media"  id="chats'+a[i].id+'" ><div class="pull-left"><!--img style="height:64px" src="128.jpg" class="media-photo"--></div><div class="msg-body"><span class="pull-right" style="font-size: 10px;" ><span  id="status'+a[i].id+'" >'+a[i].status+"</span>&nbsp;&nbsp;"+a[i].sent_on+'</span><p class="title" style="font-size: 12px;" ><b><a href="'+purl+"/msgs/g/"+a[i].url+'" style="color: #6D84B4;">'+a[i].username+'</a></b></p><p class="summary" style="font-size: 14px;" >'+a[i].message+"</p></div></div>";$("#kchatchats").prepend(data)}}function kchat_chat(a){if(!document.getElementById("kchatchats")){return false}data="";for(i=0;i<a.length;i++){if(document.getElementById("chats"+a[i].id)){document.getElementById("chats"+a[i].id).remove()}data='<div class="media"  id="chats'+a[i].id+'" ><div class="pull-left"><!--img style="height:64px" src="128.jpg" class="media-photo"--></div><div class="msg-body"><span class="pull-right" style="font-size: 10px;" ><span  id="status'+a[i].id+'" >'+a[i].status+"</span>&nbsp;&nbsp;"+a[i].sent_on+'</span><p class="title" style="font-size: 12px;" ><b><a href="'+purl+"/msgs/g/"+a[i].url+'" style="color: #6D84B4;">'+a[i].username+'</a></b></p><p class="summary" style="font-size: 14px;" >'+a[i].message+"</p></div></div>";$("#kchatchats").prepend(data)}}function set_status(a){if(!document.getElementById("status"+a[i].id)){return false}for(i=0;i<a.length;i++){$("#status"+a[i].id).html(a[i].status)}}function typing(a){if(document.getElementById("typing")){$("#typing").html("<i><b>&nbsp;"+a+"</b></i>")}}function kchat_json(b){try{chat=jQuery.parseJSON(b)}catch(c){alertify.log("<h3>Error Occurred</h3><pre>"+b+"</pre>")}if(typeof chat.online!=="undefined"){kchat_online(chat.online)}if(typeof chat.offline!=="undefined"){kchat_offline(chat.offline)}if(typeof chat.chats!=="undefined"){kchat_chat(chat.chats)}if(typeof chat.unread!=="undefined"){__set("unread",chat.unread)}if(typeof chat.message!=="undefined"){kchat_message(chat.message)}if(typeof chat.timestamp!=="undefined"){chat.timestamp=chat.timestamp}if(typeof chat.msg_status!=="undefined"){set_status(chat.msg_status)}if(typeof chat.typing!=="undefined"){typing(chat.typing)}else{if(document.getElementById("typing")){$("#typing").html("<i><b>&nbsp;</b></i>")}}if(typeof chat.rq_time!=="undefined"){$("#rq_time").html(chat.rq_time);for(var a=0;a<15;a++){kchat.rqt_graph[a]=kchat.rqt_graph[(a+1)]}kchat.rqt_graph[15]=chat.rq_time*1000;$(".dynamicsparkline").sparkline(kchat.rqt_graph)}if(typeof chat.qfired!=="undefined"){$("#qfired").html(chat.qfired)}if(typeof chat.reqps!=="undefined"){$("#reqps").html(chat.reqps)}if(typeof chat.offset!=="undefined"){kchat.offset=chat.offset}}function kchat_init(a){if(a=="true"){kchat.notify=false}else{kchat.notify=true}if(document.getElementById("kchatchats")){req.kchatchats=true}if(document.getElementById("online")){req.online=true}if(document.getElementById("messages")){req.messages=true}if(document.getElementById("typing")){req.typing=true}if(document.getElementById("unread")){req.unread=true}$.post(purl+"/ajax/chat/"+posturl,{timestamp:chat.timestamp,first_run:a,offset:kchat.offset,req:req,token:token},function(c,b){if(b==="success"){if(c==="refresh"){location.reload()}else{kchat_json(c)}}})}kchat.init=(function(){kchat_init("true");setInterval(function(){kchat_init("false")},3000)});kchat.Ready=(function(){$(".kchatemoji").emojioneArea({events:{keypress:function(a,b){var c=b?(b.which?b.which:b.keyCode):b.keyCode;aa=new Date();if(kchat.typing!==aa.getSeconds()){kchat.typing=aa.getSeconds();$.post(purl+"/ajax/typing/"+posturl,{typing:"typing",token:token},function(e,d){})}if(c==13){msg=$(".emojionearea-editor").html();if(msg==""){return false}$.post(purl+"/ajax/chat/"+posturl,{timestamp:chat.timestamp,msg:msg,first_run:"false",token:token},function(e,d){if(d==="success"){if(e==="refresh"){location.reload()}else{kchat.notify=false;kchat_json(e)}}});$(".emojionearea-editor").html("")}if(c==59){}if(c==27){}else{return true}}}})});function _loadoldmsg(){if(typeof scrl!=="undefined"){if(scrl==0){aa=new Date();if(kchat.typing!==((aa.getMilliseconds()-aa.getMilliseconds()%500)/500)){kchat.typing=((aa.getMilliseconds()-aa.getMilliseconds()%500)/500);req.premsg=true;kchat_init("false");req.premsg=false}}}}$(document).ready(function(){$("#msgscrl").scroll(function(){scrl=$("#msgscrl").scrollTop();if(scrl<=kchat.scroll){}else{}kchat.scroll=scrl});if(document.getElementById("msgscrl")){document.getElementById("msgscrl").addEventListener("wheel",_loadoldmsg)}});function notify(a){Push.create("KChat",{body:a,icon:kurl+"/kchat/assets/images/lchat.png",timeout:4000,onClick:function(){window.focus();this.close()}})};